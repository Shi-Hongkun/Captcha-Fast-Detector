# Captcha Fast Detector

A fast and pragmatic captcha project. Currently, we focus on Step 1 only: a deterministic ROI Calibrator that learns the fixed text region from the 25 training images with consistent layout.

## Features

- ROI Calibrator: learn a fixed ROI from 25 images or txt files (no ML)
- Export/import ROI as JSON for reuse
- Apply ROI to crop single images or entire folders
- Support for paired jpg+txt file processing
- Flexible input formats (images or txt files)

## Installation

This project uses [uv](https://github.com/astral-sh/uv) for fast Python package management and virtual environment handling.

### Prerequisites

Install uv if you haven't already:
```bash
pip install uv
```

### Setup

1. Clone the repository:
```bash
git clone <repository-url>
cd Captcha-Fast-Detector
```

2. Create and activate virtual environment with uv:
```bash
uv venv
uv sync
```

3. Activate the virtual environment:
```bash
# On Windows
.venv\Scripts\activate

# On macOS/Linux
source .venv/bin/activate
```

## Usage

### CLI Commands

1) Calibrate ROI from training images:
```bash
python -m captcha_detector calibrate -i data/input -r artifacts/roi/roi.json
```

2) Calibrate ROI from txt files:
```bash
python -m captcha_detector calibrate -i data/input --use-txt -r artifacts/roi/roi.json
```

3) Apply ROI to a single image:
```bash
python -m captcha_detector apply -r artifacts/roi/roi.json -i data/input/input00.jpg -o data/input_cropped/input00.jpg
```

4) Apply ROI to paired jpg+txt files:
```bash
python -m captcha_detector apply-paired -r artifacts/roi/roi.json -i input00.jpg -t input00.txt -o output00.jpg -u output00.txt
```

5) Batch-apply ROI to images:
```bash
python -m captcha_detector batch -r artifacts/roi/roi.json -i data/input -o data/input_cropped
```

6) Batch-apply ROI to paired files:
```bash
python -m captcha_detector batch -r artifacts/roi/roi.json -i data/input -o data/input_cropped_img_n_txt --paired
```

## Project Structure

```
Captcha-Fast-Detector/
├── captcha_detector/
│   ├── __init__.py
│   ├── __main__.py          # CLI for ROI calibration and application
│   └── roi_calibrator.py    # Core ROI calibration logic
├── data/
│   ├── input/               # Client-provided raw images (immutable)
│   ├── output/              # Client-provided ground-truth labels
│   ├── input_cropped/       # Cropped images using the learned ROI (jpg+txt)
├── artifacts/
│   └── roi/
│       └── roi.json         # Persisted ROI bounds (small metadata)
├── pyproject.toml
└── README.md
```

## Development

### Code Formatting (optional)

```bash
black .
```

## Method Overview

Given 25 images generated by the same captcha generator, borders are highly consistent while text varies. We:
1. Resize images to a common size (default 60×30)
2. Stack them and compute per-pixel standard deviation
3. Use Otsu threshold on the std-map to find the dynamic region (text)
4. Derive the tight bounding box, with a small safety padding
5. Persist the ROI as JSON and reuse it to crop future images

## License

This project is developed for educational and research purposes.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request